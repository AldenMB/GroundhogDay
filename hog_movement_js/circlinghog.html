<!DOCTYPE html>
<html>
<head>
<title>Demo Hog Movement</title>
</head>

<style type="text/css">
td{
  color:white;
  background-color:black;
  width:4em;
  height:4em;
  text-align:center;
}
.road{
  background-color:darkred;
}

.looped{
  color:lightgreen;
}
.stuck{
  color:red;
}
</style>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js">
</script>

<script type="text/javascript">

Tile = function Tile(board, x, y, floor){
  this.board = board;
  this.x = x;
  this.y = y;
  this.floor = floor;
  this.flans = [];
  this.houses = [];
}
Tile.prototype.appearance = function appearance(){
  var s=$("<span>");
  for (let house of this.houses){
    s.append(house.appearance());
  };
  for (let flan of this.flans){
    s.append(flan.appearance());
  };
  return s;
}
Tile.prototype.remove_flan = function remove_flan(flan){
  var index = this.flans.indexOf(flan);
  if (index > -1) {
    this.flans.splice(index,1);
  };
}
Tile.prototype.remove_house = function remove_house(house){
  var index = this.houses.indexOf(house);
  if (index > -1) {
    this.houses.splice(index,1);
  };
}
Tile.prototype.flan_pointing = function flan_pointing(direction){
  for (let flan of this.flans){
    if (flan.direction === direction){
      return flan;
    };
  };
  return false;
}
Tile.prototype.flan_going = function flan_going(direction){
  for (let flan of this.flans){
    if (flan.going() === direction){
      return flan;
    };
  };
  return false;
}
Tile.prototype.road_toggle = function road_toggle(){
  if(this.floor === ''){
    this.floor = 'r';
  } else {
    this.floor ='';
  }
}
Tile.prototype.house_toggle = function house_toggle(){
  if(this.houses.length > 0){
    this.houses[0].deconstruct();
  } else {
    new House(this.board,this.x,this.y,"N");
  }
}
Tile.prototype.on_click = function on_click(){
  switch (this.board.selected_tool){
    case "rotate_house":
      if(this.houses.length>0)this.houses[0].rotate();
      break;
    case "road_toggle":
      this.road_toggle();
      break;
    case "house_toggle":
      this.house_toggle();
      break;
    default:
      throw "no such tool as "+this.board.selected_tool;
      break;      
  }
  this.board.is_changed = true;
}

Board = function Board(width,height){
  this.width = width;
  this.height = height;
  this.axes = [...Array(height)].map(e => Array(width).fill(''));
  for(var i=0;i<width;i++){
    for(var j=0;j<height;j++){
      this.axes[i][j]= new Tile(this,i,j,'');
    }
  }
  this.flans = [];
  this.is_changed = false;
  this.number_of_steps = 0;
  this.houses = [];
  this.selected_tool = "road_toggle";
}

Board.prototype.remove_flan = function remove_flan(flan){
  var index = this.flans.indexOf(flan);
  if (index > -1) {
    this.flans.splice(index,1);
  };
}
Board.prototype.remove_house = function remove_house(house){
  var index = this.houses.indexOf(house);
  if (index > -1) {
    this.houses.splice(index,1);
  };
}
Board.prototype.step = function step(){
  for (let flan of this.flans){
    flan.has_stepped = false;
  };
  if (this.is_changed){
    for (let flan of this.flans){
      flan.looped = false;
      flan.stuck = false;
    };
    this.is_changed = false;
  };
  for (let flan of this.flans){
    flan.step();
  };
  this.number_of_steps ++;
}
Board.prototype.recall_flan = function recall_flan(){
  for (let house of this.houses){
    house.recall_flan();
  };
}
Board.prototype.reset_day = function reset_day(){
  this.number_of_steps = 0;
  this.recall_flan();
}

Board.prototype.render = function render(){
  var board_container = $("#board_container")
  var board_table = $("<table>")
  for (var i=this.height-1;i>=0;i--){
    var tr = $("<tr>")
    for (var j=0;j<this.width;j++){
      var td = $("<td>")
      if (this.axes[j][i].floor === "r") {
        td.addClass("road")
      }
      td.append(this.axes[j][i].appearance());

      clickhandlerfactory = function(i,j,board){
        return function(){
          //board.is_changed = true;
          //if(board.axes[j][i].floor === 'r'){
          //  board.axes[j][i].floor = '';
          //} else if (board.axes[j][i].floor === ''){
          //  board.axes[j][i].floor = 'r'
          //}
          board.axes[j][i].on_click();
        }
      }
      td.bind("click",clickhandlerfactory(i,j,this))
      tr.append(td)
    }
    board_table.append(tr)
  }
  board_container.empty()
  board_container.append(board_table)
  board_container.append(`This day has gone on for ${this.number_of_steps} steps`)
}


arrows = {
  "N":"↑",
  "E":"→",
  "W":"←",
  "S":"↓"
}

Flan = function Flan(board,x,y,direction){
  //variables
  this.x = x;
  this.y = y;
  this.direction = direction;
  this.board = board;
  this.has_stepped = false;
  this.is_waiting = false;
  this.looped = false;
  this.stuck = false;
  this.decorator = '';
  //change other variables upon creation
  board.flans.push(this);
  board.axes[x][y].flans.push(this);
}

Flan.prototype.tile = function tile(){
    return this.board.axes[this.x][this.y];
}

Flan.prototype.deconstruct = function deconstruct(){
  this.tile().remove_flan(this);
  this.board.remove_flan(this);
}
Flan.prototype.appearance = function appearance(){
  var s = $("<span>");
  s.addClass("flan");
  if(this.looped){
    s.addClass("looped");
  }
  if(this.stuck){
    s.addClass("stuck");
  }
  s.text(arrows[this.direction]+this.decorator);
  return s;
};
Flan.prototype.move = function move(move_direction = this.going()){
  if (move_direction === '') return;
  this.board.axes[this.x][this.y].remove_flan(this);
  switch(move_direction){
    case "N":
      this.y += 1;
      break;
    case "E":
      this.x += 1;
      break;
    case "W":
      this.x -= 1;
      break;
    case "S":
      this.y -= 1;
  }
  this.x = mod(this.x,this.board.width);
  this.y = mod(this.y,this.board.height);
  this.direction = move_direction;
  this.tile().flans.push(this);
};
Flan.prototype.move_to = function move_to(x = this.x,y=this.y,direction = this.direction){
  this.tile().remove_flan(this);
  this.x = mod(x,this.board.width);
  this.y = mod(y,this.board.height);
  this.direction = direction;
  this.tile().flans.push(this);
}
Flan.prototype.neighbor_tiles = function neighbor_tiles(){
  left_coords = this.local2absolute(-1,0);
  right_coords = this.local2absolute(1,0);
  front_coords = this.local2absolute(0,1);
  back_coords = this.local2absolute(0,-1);
  var obj = {
    left: this.board.axes[left_coords.x][left_coords.y],
    right: this.board.axes[right_coords.x][right_coords.y],
    front: this.board.axes[front_coords.x][front_coords.y],
    back: this.board.axes[back_coords.x][back_coords.y]
  };
  return obj;
  }
Flan.prototype.right = function right(){
return {"N":"E",
        "E":"S",
        "S":"W",
        "W":"N"}[this.direction]
}
Flan.prototype.left = function left(){
return {"N":"W",
        "W":"S",
        "S":"E",
        "E":"N"}[this.direction]
}
Flan.prototype.back = function back(){
  return {"N":"S",
          "S":"N",
          "W":"E",
          "E":"W"}[this.direction]
}
Flan.prototype.going = function going(){
  if (this.neighbor_tiles().front.floor === 'r'){
    return this.direction;
  } else if (this.neighbor_tiles().right.floor === 'r'){
    return this.right();
  } else if (this.neighbor_tiles().left.floor === 'r'){
    return this.left();
  }
  return '';
}
Flan.prototype.following = function following(){
  var temp_flan = new Flan(this.board,this.x,this.y,this.direction);
  temp_flan.move();
  var test_tile = temp_flan.tile();
  var test_direction = temp_flan.going();
  temp_flan.deconstruct();
  //if (test_tile === this.tile) return false;
  return test_tile.flan_going(test_direction);
}
Flan.prototype.going_to_t = function going_to_t(){
  var temp_flan = new Flan(this.board,this.x,this.y,this.direction);
  temp_flan.move();
  if (temp_flan.tile() === this.tile()){
    temp_flan.deconstruct;
    return false;
  }
  var temp_flan_neighbors = temp_flan.neighbor_tiles();
  var condition = (temp_flan_neighbors.front.floor === '' &&
               temp_flan_neighbors.right.floor === 'r'&&
               temp_flan_neighbors.left.floor === 'r');
  temp_flan.deconstruct();
  return condition;
}
Flan.prototype.flan_competing_for_t = function flan_competing_for_t(){
  if (! this.going_to_t()) return false;
  var temp_flan = new Flan(this.board,this.x,this.y,this.direction);
  temp_flan.move();
  var ret_val = temp_flan.neighbor_tiles().left.flan_going(temp_flan.right());
  temp_flan.deconstruct();
  if (ret_val.has_stepped){
    return false;
  }
  return ret_val;
}
Flan.prototype.step = function step(){
  if (this.has_stepped || this.stuck){return};
  next_flan = this.following();
  if (next_flan === this){
    this.stuck = true;
    this.has_stepped = true;
    return;
  }
  if (this.looped){
    this.has_stepped = true;
    this.move();
    if (next_flan){
      next_flan.step();
    }
    return;
  }
  if (next_flan){
    if (next_flan.looped || next_flan.stuck){
      this.stuck = true;
      this.has_stepped = true;
      return;
    }
    if (next_flan.is_waiting){ // We found a new loop. Inform the others, then advance the whole loop.
      this.looped = true;
      f = next_flan;
      while (f !== this){
        f.looped = true;
        f = f.following();
      }
      //next_flan.looped = true;
      this.move();
      this.has_stepped = true;
      next_flan.step();
      return;
    }
    this.is_waiting = true;
    next_flan.step(); //let the next flan get out of the way.
    this.is_waiting = false;
    //if (this.has_stepped){
    //  return;
    //}
    if (this.following()){ //the flan we are following could not move, or another flan took its place. Stop.
      if (this.following.looped || this.following.stuck){
        this.stuck=true;
      }
      this.has_stepped = true;
      return;
    }
    if (this.flan_competing_for_t()){ //let another flan into the procession. Stop.
      this.flan_competing_for_t().step();
      this.has_stepped = true;
      return;
    }
    // we can fill the space we were following. Move and stop.
    this.move();
    this.has_stepped = true;
    return;
  }
  //we are not following anyone, i.e. our target space is open.
  if (this.flan_competing_for_t()){ //let another flan into the procession. Stop.
      this.flan_competing_for_t().step();
      this.has_stepped = true;
      return;
  }
  //we have priority for entering our target. Move and stop.
  this.move();
  this.has_stepped = true;
  return;
}

function mod(m,n){
  return (m%n + n)%n;
}

//This function rotates a vector (x,y) "n" steps clockwise.
function rotate(x,y,n){
  n = mod(n,4);
  for(var i=0;i<n;i++){
    var temp=y;
    y=-x;
    x=temp;
  }
  var obj = {
    x:x,
    y:y
  };
  return obj;
}

//This function gives the absolute coordinates of a 
//space that is "right" spaces to the right and "ahead" spaces
//ahead from the flan.
Flan.prototype.local2absolute = function local2absolute(right,ahead){
  var turns = {"N":0,
           "E":1,
           "S":2,
           "W":3}[this.direction];
  var shift = rotate(right,ahead,turns);
  var x = this.x + shift.x;
  var y = this.y + shift.y;
  x=mod(x,this.board.width);
  y=mod(y,this.board.height);
  var obj ={
    x:x,
    y:y
  };
  return obj;
}

//This function gives the local coordinates of a point (x,y)
//in terms of the number of spaces "right" and "ahead" of the flan
Flan.prototype.absolute2local = function absolute2local(x,y){
  x=mod(x,this.board.width);
  y=mod(y,this.board.height);
  var shift={
    x: x-this.x,
    y: y-this.y
  };
  var turns = {"N":0,
           "E":1,
           "S":2,
           "W":3}[this.direction];
  var locals = rotate(shift.x,shift.y,-turns);
  var obj ={
    right:locals.x,
    ahead:locals.y
  };
  return obj;
}

class House {
  constructor(board,i,j,direction, decorator = ""){
    this.board = board;
    this.tile = board.axes[i][j];
    this.direction = direction;
    this.decorator = decorator;
    this.flan = new Flan(board,i,j,direction);
    this.flan.decorator = decorator;
    this.board.houses.push(this);
    this.tile.houses.push(this);
  }
  appearance(){
    return "H"+this.decorator+arrows[this.direction];
  }
  recall_flan(){
    this.flan.move_to(this.tile.x,this.tile.y,this.direction);
    this.board.is_changed = true;
  }
  deconstruct(){
    this.flan.deconstruct();
    this.board.remove_house(this);
    this.tile.remove_house(this);
  }
  rotate(times = 1){
    for (var i=0; i<times; i++){
      this.direction = {"N":"E",
                        "E":"S",
                        "S":"W",
                        "W":"N"}[this.direction];
    }
    this.recall_flan();
  }
}


b = new Board(5,6);

b.axes[1][4].floor="r";
b.axes[2][1].floor="r";
b.axes[2][2].floor="r";
b.axes[2][4].floor="r";
b.axes[3][1].floor="r";
b.axes[3][2].floor="r";
b.axes[3][3].floor="r";
b.axes[3][4].floor="r";
h1 = new House(b,0,4,"E","1");
h2 = new House(b,1,5,"S","2");
h3 = new House(b,1,3,"N","3");
h4 = new House(b,2,3,"N","4");

setInterval(function(){
  b.step();
  b.render();
  },500)

$(document).ready(function(){
    $("#reset").click(function(){
        b.reset_day();
    });
    $("#rotate_house").click(function(){
        b.selected_tool = "rotate_house";
    });
    $("#road_toggle").click(function(){
        b.selected_tool = "road_toggle";
    });
    $("#house_toggle").click(function(){
        b.selected_tool = "house_toggle";
    });
});

</script>

<body>
 <div id="board_container">

 </div>
 <div id="reset_button">
    <button id="reset"> Reset </button>
 </div>
 <div id="tools">
 Tools:
 <button id="rotate_house"> Rotate House </button>
 <button id="road_toggle"> Road Toggle </button>
 <button id="house_toggle"> House Toggle </button>
 </div>
</body>

</html>
